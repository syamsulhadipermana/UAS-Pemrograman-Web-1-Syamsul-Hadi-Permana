<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - SS Guitar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { max-width: 1200px; }
    .admin-section { margin-bottom: 40px; }
    .loader { display: none; text-align: center; }
    .loader.active { display: block; }
    .delete-btn { padding: 5px 10px; font-size: 12px; }
    .product-row { padding: 10px; border-bottom: 1px solid #eee; }
    .product-row:hover { background: #f9f9f9; }
  </style>
</head>
<body>

<!-- ================= HEADER ================= -->
<header class="site-header">
  <div class="container d-flex align-items-center justify-content-between">
    <a href="admin.html" class="brand">Admin Panel</a>
    <nav class="nav-links">
      <span id="admin-name" class="text-muted me-3"></span>
      <a href="#" id="logoutBtn">Logout</a>
    </nav>
  </div>
</header>

<!-- ================= MAIN ================= -->
<main class="container admin-container py-5">

  <!-- TAMBAH PRODUK SECTION -->
  <section class="admin-section">
    <h2 class="fw-bold mb-4">‚ûï Tambah Produk Baru</h2>

    <form id="add-product-form" class="card p-4 shadow-sm">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Nama Produk</label>
          <input type="text" name="name" class="form-control" placeholder="Contoh: Gibson SG Modern" required minlength="3">
          <small class="text-danger" id="name-error"></small>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Harga (Rp)</label>
          <input type="number" name="price" class="form-control" placeholder="Contoh: 5000000" required min="1">
          <small class="text-danger" id="price-error"></small>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Nama File Gambar</label>
          <input type="text" name="image" class="form-control" placeholder="Contoh: SG_Modern.webp" required>
          <small class="text-muted">Format: nama_file.webp atau .jpg</small>
          <small class="text-danger" id="image-error"></small>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Kategori</label>
          <select name="category" class="form-control">
            <option value="Original">SG Original</option>
            <option value="Modern">SG Modern</option>
            <option value="Exclusive">SG Exclusive</option>
            <option value="Historic">SG Historic</option>
          </select>
        </div>

        <div class="col-12 mb-3">
          <label class="form-label fw-bold">Deskripsi</label>
          <textarea name="description" class="form-control" placeholder="Deskripsikan detail produk..." required minlength="10" rows="4"></textarea>
          <small class="text-danger" id="desc-error"></small>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-dark">Tambah Produk</button>
        <button type="reset" class="btn btn-outline-secondary">Reset</button>
      </div>
      <div id="form-msg" class="mt-3"></div>
    </form>
  </section>

  <hr class="my-5">

  <!-- DAFTAR PRODUK SECTION -->
  <section class="admin-section">
    <h2 class="fw-bold mb-4">üìã Daftar Produk</h2>

    <div class="loader active" id="loading-indicator">
      <div class="spinner-border text-dark" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div id="product-list"></div>
  </section>

</main>

<!-- ================= FOOTER ================= -->
<footer class="site-footer">
  @Copyright by 23552011332_Syamsul Hadi Permana_TIF RP 23 CNS B_UASWEB1
</footer>

<script src="js/script.js"></script>
<script>
// ================= ADMIN SETUP =================
document.addEventListener("DOMContentLoaded", function() {
  // Check login
  const user = localStorage.getItem("loggedUser");
  const role = localStorage.getItem("loggedUserRole");
  const name = localStorage.getItem("loggedUserName");

  if (!user || role !== "admin") {
    alert("‚õî Akses ditolak! Hanya admin yang bisa akses halaman ini.");
    window.location.href = "login.html";
    return;
  }

  // Set welcome message
  document.getElementById("admin-name").textContent = `üë§ ${name}`;

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.removeItem("loggedUser");
    localStorage.removeItem("loggedUserName");
    localStorage.removeItem("loggedUserRole");
    window.location.href = "index.html";
  });

  // Load products
  loadAdminProducts();
});

// ================= LOAD PRODUCTS FOR ADMIN =================
function loadAdminProducts() {
  const loading = document.getElementById("loading-indicator");
  const productList = document.getElementById("product-list");

  loading.classList.add("active");
  productList.innerHTML = "";

  setTimeout(() => {
    fetchProducts().then(() => {
      renderAdminProductList();
      loading.classList.remove("active");
    }).catch(() => {
      loading.classList.remove("active");
      productList.innerHTML = '<div class="alert alert-danger">‚ùå Gagal memuat produk</div>';
    });
  }, 500);
}

// ================= RENDER ADMIN PRODUCT LIST =================
function renderAdminProductList() {
  const wrap = document.getElementById("product-list");
  if (!wrap) return;

  if (guitars.length === 0) {
    wrap.innerHTML = '<div class="alert alert-info">üì≠ Belum ada produk. Tambahkan yang baru!</div>';
    return;
  }

  let html = `
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>No</th>
            <th>Nama Produk</th>
            <th>Harga</th>
            <th>Gambar</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
  `;

  guitars.forEach((g, idx) => {
    html += `
      <tr>
        <td>${idx + 1}</td>
        <td><strong>${g.name}</strong></td>
        <td>Rp ${Number(g.price).toLocaleString("id-ID")}</td>
        <td><small class="text-muted">${g.image}</small></td>
        <td>
          <button class="btn btn-sm btn-warning me-2" onclick="editProduct(${g.id})" disabled title="Coming soon">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteAdminProduct(${g.id})">Hapus</button>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
    <div class="alert alert-info mt-3">
      üìä Total: <strong>${guitars.length}</strong> produk
    </div>
  `;

  wrap.innerHTML = html;
}

// ================= DELETE PRODUCT ADMIN VERSION =================
function deleteAdminProduct(id) {
  if (!confirm("‚ö†Ô∏è Yakin mau hapus produk ini? Tindakan tidak bisa dibatalkan!")) return;

  deleteProduct(id);
}

// ================= FORM VALIDATION =================
document.getElementById("add-product-form").addEventListener("submit", async function(e) {
  e.preventDefault();

  // Clear previous errors
  document.querySelectorAll("small.text-danger").forEach(el => el.textContent = "");

  const name = document.querySelector('[name="name"]').value.trim();
  const price = parseFloat(document.querySelector('[name="price"]').value);
  const image = document.querySelector('[name="image"]').value.trim();
  const description = document.querySelector('[name="description"]').value.trim();

  let isValid = true;

  // Validation
  if (name.length < 3) {
    document.getElementById("name-error").textContent = "Minimal 3 karakter";
    isValid = false;
  }

  if (price < 1 || isNaN(price)) {
    document.getElementById("price-error").textContent = "Harga harus angka positif";
    isValid = false;
  }

  if (!image.match(/\.(webp|jpg|jpeg|png)$/i)) {
    document.getElementById("image-error").textContent = "Format gambar: .webp, .jpg, .jpeg, .png";
    isValid = false;
  }

  if (description.length < 10) {
    document.getElementById("desc-error").textContent = "Minimal 10 karakter";
    isValid = false;
  }

  if (!isValid) return;

  // Submit
  const formData = new FormData(this);
  await insertProduct(formData);

  this.reset();
  loadAdminProducts();
});
</script>

</body>
</html>
